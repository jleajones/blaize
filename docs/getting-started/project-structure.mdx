# ğŸ“ Project structure

> **Understand BlaizeJS's monorepo architecture, package organization, and development workflow**

BlaizeJS is organized as a **monorepo** using **pnpm workspaces** and **Turborepo** for efficient package management and build orchestration. This structure enables shared tooling, consistent versioning, and streamlined development across all framework packages.

---

## ğŸ“¦ Monorepo layout

```
blaize/
â”œâ”€â”€ ğŸ“¦ packages/           # Published npm packages
â”‚   â”œâ”€â”€ blaize-core/      # Main framework (blaizejs)
â”‚   â”œâ”€â”€ blaize-client/    # Type-safe RPC client (@blaizejs/client)
â”‚   â”œâ”€â”€ blaize-types/     # Shared TypeScript types (internal)
â”‚   â”œâ”€â”€ blaize-testing-utils/  # Testing utilities (@blaizejs/testing-utils)
â”‚   â””â”€â”€ create-blaize-app/     # CLI scaffolding tool (create-blaize-app)
â”‚
â”œâ”€â”€ ğŸ”Œ plugins/            # Official framework plugins
â”‚   â”œâ”€â”€ cache/            # @blaizejs/plugin-cache
â”‚   â”œâ”€â”€ queue/            # @blaizejs/plugin-queue
â”‚   â””â”€â”€ metrics/          # @blaizejs/plugin-metrics
â”‚
â”œâ”€â”€ ğŸ”— adapters/           # Storage and service adapters
â”‚   â””â”€â”€ redis/            # @blaizejs/adapter-redis
â”‚
â”œâ”€â”€ ğŸ›¡ï¸ middleware/         # Official middleware packages
â”‚   â””â”€â”€ security/         # @blaizejs/middleware-security
â”‚
â”œâ”€â”€ ğŸ¯ apps/               # Applications and examples
â”‚   â”œâ”€â”€ docs/             # Documentation website
â”‚   â”œâ”€â”€ playground/       # Development testing environment
â”‚   â””â”€â”€ examples/         # Example applications
â”‚
â”œâ”€â”€ âš™ï¸ configs/            # Shared configurations
â”‚   â”œâ”€â”€ eslint-config/    # @blaizejs/eslint-config
â”‚   â”œâ”€â”€ tsconfig/         # @blaizejs/tsconfig
â”‚   â”œâ”€â”€ tsup/             # @blaizejs/tsup-config
â”‚   â””â”€â”€ vitest/           # @blaizejs/vitest-config
â”‚
â”œâ”€â”€ pnpm-workspace.yaml   # Workspace configuration
â”œâ”€â”€ turbo.json            # Turborepo configuration
â”œâ”€â”€ package.json          # Root package scripts
â””â”€â”€ tsconfig.json         # Root TypeScript config
```

---

## ğŸ“š Package categories

### Published packages (`packages/`)

These packages are released to npm and follow semantic versioning with changesets:

| Package | Description | Published As |
|---------|-------------|--------------|
| **blaize-core** | Core framework with server, routing, middleware, and plugin system | `blaizejs` |
| **blaize-client** | Type-safe RPC client with end-to-end type inference | `@blaizejs/client` |
| **blaize-testing-utils** | Testing utilities including mock context and server helpers | `@blaizejs/testing-utils` |
| **create-blaize-app** | CLI scaffolding tool for new projects | `create-blaize-app` |
| **blaize-types** | Shared TypeScript type definitions (internal, bundled with core) | _(not published)_ |

**Key characteristics:**
- Require [changesets](../contributing#changesets) for version management
- Follow strict backward compatibility rules
- Comprehensive test coverage (90%+ required)
- Full API documentation with JSDoc

### Plugins (`plugins/`)

Official plugins that add optional functionality to the framework:

| Plugin | Purpose | Install |
|--------|---------|---------|
| **cache** | In-memory and Redis caching with adapter pattern | `@blaizejs/plugin-cache` |
| **queue** | Background job processing with local and Redis backends | `@blaizejs/plugin-queue` |
| **metrics** | Prometheus-compatible metrics collection | `@blaizejs/plugin-metrics` |

**Design principles:**
- Optional dependencies (peer dependencies on core)
- Zero-config local development
- Production-ready adapters available
- Lifecycle hooks integration

### Adapters (`adapters/`)

Storage and service adapters for plugins:

| Adapter | Purpose | Used By |
|---------|---------|---------|
| **redis** | Redis integration for caching and queues | cache, queue plugins |

**Adapter pattern:**
- Interface-driven design
- Local implementations for development
- Production adapters for scaling
- No vendor lock-in

### Middleware (`middleware/`)

Official middleware packages:

| Middleware | Purpose | Features |
|------------|---------|----------|
| **security** | Security headers (CSP, HSTS, X-Frame-Options) | Zero-config secure defaults |

### Applications (`apps/`)

Internal applications and examples (not published to npm):

| App | Purpose | Technology |
|-----|---------|------------|
| **docs** | Documentation website | Next.js, MDX |
| **playground** | Development testing environment | TypeScript, Docker Compose |
| **examples/** | Example applications demonstrating framework features | Various |

### Configurations (`configs/`)

Shared tooling configurations:

| Config | Purpose | Extends |
|--------|---------|---------|
| **eslint-config** | Linting rules for monorepo | ESLint 9 flat config |
| **tsconfig** | TypeScript base configurations | Strict mode, ESM |
| **tsup** | Build configuration for packages | Fast ESM builds |
| **vitest** | Test configuration for packages | Vitest, coverage |

---

## ğŸ”§ Workspace configuration

### pnpm workspace

The `pnpm-workspace.yaml` defines which directories contain packages:

```yaml
packages:
  # Core packages
  - 'packages/*'
  
  # Adapter packages
  - 'adapters/*'
  
  # Middleware packages
  - 'middleware/*'
  
  # Plugin packages
  - 'plugins/*'
  
  # Apps and examples (nested structure)
  - 'apps/**'
  
  # Shared configurations
  - 'configs/*'
```

**Why nested `apps/**`?**  
Example applications are organized in subdirectories (`apps/examples/*/`), so the glob pattern `apps/**` ensures all nested projects are included in the workspace.

### Turborepo configuration

Turborepo orchestrates builds, tests, and linting across the monorepo:

```json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "test": {
      "dependsOn": ["build"]
    },
    "lint": {},
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

**Key features:**
- **Dependency-aware builds**: Packages build in the correct order
- **Caching**: Skips unchanged packages for faster iterations
- **Parallel execution**: Runs tasks across packages simultaneously
- **Persistent tasks**: Dev servers run continuously

---

## ğŸ—ï¸ Package structure

Each package follows a consistent structure:

```
package-name/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Main entry point
â”‚   â”œâ”€â”€ [feature]/        # Feature modules
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ [feature].test.ts  # Colocated tests
â”‚   â””â”€â”€ types/            # Type definitions
â”œâ”€â”€ dist/                 # Build output (gitignored)
â”œâ”€â”€ package.json          # Package configuration
â”œâ”€â”€ tsconfig.json         # TypeScript config (extends base)
â”œâ”€â”€ vitest.config.ts      # Test configuration
â””â”€â”€ README.md             # Package documentation
```

**Conventions:**
- **Colocated tests**: Test files live next to implementation
- **Index exports**: Clean public API through `index.ts`
- **TypeScript strict mode**: All packages use strict type checking
- **ESM-first**: Native ES modules, no CommonJS

---

## ğŸ“– Key directories explained

### Core framework (`packages/blaize-core/`)

The heart of BlaizeJS:

```
blaize-core/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server/           # Server creation and lifecycle
â”‚   â”œâ”€â”€ router/           # File-based routing engine
â”‚   â”œâ”€â”€ middleware/       # Middleware system
â”‚   â”œâ”€â”€ plugins/          # Plugin lifecycle management
â”‚   â”œâ”€â”€ context/          # Request context (AsyncLocalStorage)
â”‚   â”œâ”€â”€ errors/           # BlaizeError classes (12 semantic types)
â”‚   â”œâ”€â”€ sse/              # Server-Sent Events implementation
â”‚   â”œâ”€â”€ logger/           # Logging interface and adapters
â”‚   â””â”€â”€ utils/            # Shared utilities
â””â”€â”€ package.json          # Exports "blaizejs"
```

**Design highlights:**
- **HTTP/2-native**: Default server implementation
- **Functional core**: Pure functions over classes
- **Type accumulation**: Middleware types compose through server
- **Zero dependencies** (except `zod` for validation)

### Type-safe client (`packages/blaize-client/`)

RPC client with end-to-end type inference:

```
blaize-client/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ client.ts         # Main client factory
â”‚   â”œâ”€â”€ types.ts          # Type inference helpers
â”‚   â””â”€â”€ fetch/            # HTTP client implementation
â””â”€â”€ package.json          # Exports "@blaizejs/client"
```

**Features:**
- Infers types from server route exports
- Supports all HTTP methods
- Query params, body, and URL params type-safe
- Works in Node.js and browsers

### Testing utilities (`packages/blaize-testing-utils/`)

Testing helpers for BlaizeJS applications:

```
blaize-testing-utils/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ context.ts        # createTestContext, createMockContext
â”‚   â”œâ”€â”€ server.ts         # createMockServer
â”‚   â”œâ”€â”€ middleware.ts     # createMockMiddleware
â”‚   â””â”€â”€ plugin.ts         # createMockPlugin, getPluginHooks
â””â”€â”€ package.json          # Exports "@blaizejs/testing-utils"
```

**Usage:**
```typescript
import { createTestContext } from '@blaizejs/testing-utils';

const ctx = createTestContext({ method: 'POST', path: '/users' });
const result = await POST.handler(ctx, {});
```

### CLI scaffolding (`packages/create-blaize-app/`)

Project scaffolding tool:

```
create-blaize-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # CLI entry point
â”‚   â”œâ”€â”€ commands/         # CLI commands
â”‚   â”œâ”€â”€ templates/        # Project templates
â”‚   â””â”€â”€ utils/            # CLI utilities
â””â”€â”€ package.json          # Exports "create-blaize-app"
```

**Features:**
- Zero-config project setup
- Multiple template options
- Package manager detection
- Git initialization

### Playground (`apps/playground/`)

Development environment for testing framework features:

```
playground/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Server setup with all plugins
â”‚   â”œâ”€â”€ routes/           # Test routes
â”‚   â”œâ”€â”€ data/             # Sample data
â”‚   â””â”€â”€ middleware/       # Test middleware
â”œâ”€â”€ docker-compose.yml    # Redis, PostgreSQL for integration tests
â””â”€â”€ package.json          # Dev-only, not published
```

**Purpose:**
- Test plugins with real services (Redis, PostgreSQL)
- Validate SSE implementations
- Experiment with new features
- Performance benchmarking

---

## ğŸ”„ Development workflow

### Working across packages

```bash
# Install all dependencies
pnpm install

# Build all packages (respects dependency order)
pnpm build

# Run tests across monorepo
pnpm test

# Lint all packages
pnpm lint

# Type check everything
pnpm type-check

# Start playground dev server
pnpm --filter @blaizejs/playground dev
```

### Working on a single package

```bash
# Run commands in specific package
pnpm --filter blaizejs test
pnpm --filter @blaizejs/client build

# Run dev mode for a package
pnpm --filter blaizejs dev
```

### Package dependencies

Packages reference each other using workspace protocol:

```json
{
  "dependencies": {
    "blaizejs": "workspace:*",
    "@blaizejs/adapter-redis": "workspace:*"
  }
}
```

**How it works:**
- During development: Symlinks to local packages
- During publishing: Replaced with actual version numbers
- Turborepo handles build order automatically

---

## ğŸš€ Publishing flow

### Published vs internal packages

| Category | Published | Requires Changeset |
|----------|-----------|-------------------|
| `packages/blaize-core` | âœ… Yes â†’ `blaizejs` | âœ… Required |
| `packages/blaize-client` | âœ… Yes â†’ `@blaizejs/client` | âœ… Required |
| `packages/blaize-testing-utils` | âœ… Yes â†’ `@blaizejs/testing-utils` | âœ… Required |
| `packages/create-blaize-app` | âœ… Yes â†’ `create-blaize-app` | âœ… Required |
| `packages/blaize-types` | âŒ No (bundled with core) | âŒ Not required |
| `plugins/*` | âœ… Yes | âœ… Required |
| `adapters/*` | âœ… Yes | âœ… Required |
| `middleware/*` | âœ… Yes | âœ… Required |
| `apps/*` | âŒ No | âŒ Not required |
| `configs/*` | âŒ No (internal tooling) | âŒ Not required |

### Changeset workflow

```bash
# 1. Make changes to published package
# 2. Create changeset
pnpm changeset

# 3. Select packages and version bump type (patch/minor/major)
# 4. Write changelog entry
# 5. Commit changeset file
git add .changeset/
git commit -m "ğŸš€ Add new feature"

# 6. On merge to main, GitHub Action creates "Version Packages" PR
# 7. Merging that PR publishes to npm automatically
```

---

## ğŸ“‹ File conventions

### Naming

| File Type | Convention | Example |
|-----------|-----------|---------|
| Source files | `kebab-case.ts` | `route-handler.ts` |
| Test files | `[name].test.ts` | `route-handler.test.ts` |
| Type files | `[name].types.ts` | `server.types.ts` |
| Config files | `[tool].config.ts` | `vitest.config.ts` |

### Exports

```typescript
// âŒ Don't use deep imports
import { Server } from 'blaizejs/dist/server';

// âœ… Import from package root
import { Server } from 'blaizejs';
```

**Why?** Internal structure can change; public API via `index.ts` is stable.

### Testing

```typescript
// âœ… Colocate tests with implementation
src/
  server/
    index.ts
    index.test.ts        // Tests for server
    lifecycle.ts
    lifecycle.test.ts    // Tests for lifecycle

// âŒ Don't separate tests into __tests__ directory
```

---

## ğŸ¯ Adding a new package

### Step 1: Create package directory

```bash
# Choose appropriate category
mkdir -p plugins/my-feature
cd plugins/my-feature
```

### Step 2: Create package.json

```json
{
  "name": "@blaizejs/plugin-my-feature",
  "version": "0.1.0",
  "description": "Description of plugin",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch",
    "test": "vitest run",
    "test:watch": "vitest",
    "type-check": "tsc --noEmit"
  },
  "peerDependencies": {
    "blaizejs": "workspace:*"
  },
  "devDependencies": {
    "@blaizejs/tsconfig": "workspace:*",
    "@blaizejs/tsup-config": "workspace:*",
    "blaizejs": "workspace:*"
  }
}
```

### Step 3: Create TypeScript config

```json
{
  "extends": "@blaizejs/tsconfig/base.json",
  "compilerOptions": {
    "outDir": "dist",
    "rootDir": "src"
  },
  "include": ["src"]
}
```

### Step 4: Create build config

```typescript
// tsup.config.ts
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  dts: true,
  clean: true,
  sourcemap: true,
});
```

### Step 5: Create source structure

```bash
mkdir -p src
touch src/index.ts
touch src/plugin.ts
touch src/plugin.test.ts
```

### Step 6: Add to workspace

Package is automatically included if in a workspace glob pattern. Verify:

```bash
pnpm install
pnpm --filter @blaizejs/plugin-my-feature build
```

---

## ğŸ” Finding your way around

### "Where should I add...?"

| You want to add... | Add it to... |
|-------------------|--------------|
| Core framework feature | `packages/blaize-core/src/` |
| New error class | `packages/blaize-core/src/errors/` |
| RPC client feature | `packages/blaize-client/src/` |
| Testing helper | `packages/blaize-testing-utils/src/` |
| Background job processing | `plugins/queue/` |
| Caching system | `plugins/cache/` |
| Security headers | `middleware/security/` |
| Redis adapter | `adapters/redis/` |
| Example application | `apps/examples/` |
| Documentation page | `apps/docs/pages/` |
| Shared ESLint rule | `configs/eslint-config/` |

### Common tasks

**Add a dependency to a package:**
```bash
pnpm --filter @blaizejs/plugin-cache add redis
```

**Run tests for changed packages only:**
```bash
pnpm test --filter=[HEAD^1]
```

**Build in watch mode:**
```bash
pnpm --filter blaizejs dev
```

**Clear all build artifacts:**
```bash
pnpm clean
```

---

## âš™ï¸ Configuration files

### Root configuration

| File | Purpose |
|------|---------|
| `pnpm-workspace.yaml` | Defines workspace packages |
| `turbo.json` | Build and task orchestration |
| `package.json` | Root scripts and dev dependencies |
| `tsconfig.json` | Base TypeScript config |
| `.eslintrc.js` | Root linting rules |
| `.prettierrc` | Code formatting |
| `.gitignore` | Git ignore patterns |

### Package configuration

| File | Purpose |
|------|---------|
| `package.json` | Package metadata, scripts, dependencies |
| `tsconfig.json` | TypeScript settings (extends base) |
| `vitest.config.ts` | Test configuration |
| `tsup.config.ts` | Build configuration |

---

## ğŸ“ Best practices

### Dependency management

âœ… **Do:**
- Install runtime dependencies at package level
- Use `workspace:*` for internal dependencies
- Keep peer dependencies minimal
- Avoid circular dependencies

âŒ **Don't:**
- Install runtime dependencies at root level
- Add unnecessary dependencies
- Use wildcards for external packages

### Package boundaries

âœ… **Do:**
- Keep packages focused and cohesive
- Define clear public APIs via `index.ts`
- Document all exported functions

âŒ **Don't:**
- Import from internal package paths
- Create circular dependencies between packages
- Expose implementation details

### Testing

âœ… **Do:**
- Colocate tests with implementation
- Achieve 90%+ coverage for published packages
- Test public APIs, not internals
- Use integration tests for complex workflows

âŒ **Don't:**
- Skip tests for edge cases
- Mock internal implementation details
- Test TypeScript types (use type-level tests instead)

---

## ğŸ”— Related documentation

- **[Contributing guide](../contributing)** â€” How to contribute to BlaizeJS
- **[Architecture overview](../architecture)** â€” Framework architecture
- **[Release management](../contributing/release-management)** â€” Versioning and publishing

---

## ğŸ’¡ Quick tips

**For contributors:**
- Start with the playground to test changes
- Use `pnpm --filter` to work on specific packages
- Run `pnpm build` before `pnpm test` for cross-package changes
- Check `turbo.json` to understand task dependencies

**For users:**
- The `blaizejs` package contains everything you need to start
- Plugins are optional and can be added as needed
- Example applications show real-world usage patterns
- Testing utilities make testing BlaizeJS apps straightforward

---

**Built with â¤ï¸ by the BlaizeJS team**

*Understanding the project structure helps you navigate the codebase, contribute effectively, and leverage the full power of BlaizeJS.*